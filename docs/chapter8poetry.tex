\chapter{Typesetting poetry}
\label{ch:poetry}

As noted in \Cref{ch:intro}, a key aim of \textbf{Andika!} is to facilitate the production of digital versions of classical Swahili manuscripts.  This chapter deals with the tools provided to do that -- they are based on the concept of importing each word of the text into a database table, and then adding material such as notes on individual words or sections, variant readings and emendations, translations, etc.  The enriched text can then be output in a number of formats allowing for both print and online publication -- see \Cref{s:output}.  This approach also facilitates the automatic production of word frequency lists, glossaries, concordances, n-grams, and so on, which open the way for detailed linguistic analysis of the text.

This chapter focusses on the possibilities for typesetting traditional poetry in Arabic script.  However, the tools can also be used for prose in Arabic script -- this aspect could be developed further if there is demand for it.


\section{Creating the input document}

The first step is to manually transcribe the manuscript letter-for-letter into a LibreOffice \textit{odt} document -- virtually all the Arabic glyphs likely to be used in a manuscript are already on the layout described in \Cref{ch:keyboard}, and it is actually faster to type the Arabic text into the computer than it is to type in a close transliteration. 

Each \textit{kipande} of a poem in traditional metre should be placed on its own line, and each stanza should be separated by a blank line. The LibreOffice document should end with one blank line.

Particles such as  \AS{لَ زَ يَ نَ} (\textbf{na, ya, za, la}) are best written according to the manuscript rendering. In many instances the author or copyist may have attached them to the following word, or (in the case of non-connecting letters like \AS{زَ}) placed them very close to it. But where there is a larger space in the manuscript between the particle and the following word, it may be appropriate to write it separately from that word in the transcription. These decisions are subjective, and may produce some inconsistency in the transcription, but they will reflect the manuscript more faithfully.  Connection or disconnection of the particles (in line with standard Roman orthography) will be handled by annotating the entries in the database.

Samples of input files are in \url{andika/convert/inputs} and subfolders.

\subsection{Checking the input file}

It is a good idea to check your input file every few stanzas or so by using the convert tools to output a pdf with transliteration.  This will help you to note and correct typos as you go along.


\section{Importing the contents into a database table}
\label{s:import}

Once the manuscript is transcribed in the input file, it can be imported into a database table.  This is done by using the conversion tools, but specifying database import instead of output in a particular document format.  To use the point-and-click interface (\Cref{ss:pacint}), open a terminal and run:

\verb|convert/convert.sh|

choose your poem, and then select \textit{Insert into database} on the \textit{Output} screen.  To use the command-line interface (\Cref{ss:cliput}), run the following command (replacing \textit{vita_vikuu} with the name of the poem) :

\verb|php convert/convert.php convert/inputs/vita_vikuu/vita_vikuu.odt+Arabic+Poetry|\\
$\hookrightarrow$ \verb|+db+kip-line|

In both cases, a database table of the same name as the poem (in the above case, \textit{vita_vikuu}) will be created in the \textit{andika} database, and each \textit{kipande} of the poem will be imported into that table.  During this import, the Arabic text is transliterated into standard Roman orthography, and also into a close transliteration which more closely reflects the Arabic glyphs.

To view the database table, you can access it using phpPgAdmin: in a browser, enter \url{localhost/phppgadmin} and log in to the PostgreSQL server.  In the left panel, click the + beside \textit{andika}, and then \textbf{Tables}, and then click on \textbf{Browse} alongside the name of the poem (in this case, \textit{vita_vikuu}).  You should see the first part of the contents of the table, and for each \textit{kipande} of the poem, there will be:
\begin{itemize}
\item A computer-assigned index number (\textit{poemline_id}).
\item The stanza number as written on the original manuscript (\textit{msno}).  If the original stanza numbers were not entered on the input document (see \Cref{s:layout}), a zero will be entered here instead.  The difference between this and the following \textit{stanza} is that human scribes or copyists make mistakes -- they may miss out a number, or give two stanzas the same number.  However, for manuscript work (see \Cref{ch:multiple}) it may be useful to record this number in any case.
\item The stanza number as generated by the software (\textit{stanza}).  This will always be correct (i.e. increment by 1 for each stanza in the poem). The default import numbers the stanzas from 1 onwards, and for simplicity, that is retained in the examples in this section, but it is easy to change the numbering to reflect the actual stanza numbers  -- see \Cref{ss:stanzano}.
\item The location of the line in the stanza (\textit{loc}).  This is in the form of a lowercase Roman letter: a, b, c, d, etc.
\item The Arabic text (\textit{arabic}).  Some cells in the Arabic column may appear empty, but this seems to be a display bug in phpPgAdmin -- if you press \textbf{Edit} you can see the text is there, and a \textit{select} query will also show it.
\item The close transcription (\textit{close}).
\item The standard transcription (\textit{standard}).
\end{itemize}

\subsection{The import process hangs}

If the database import process hangs (i.e. appears to be doing nothing), this is because you have the relevant poem table open in SQL Workbench (for example, to review the import, or add annotations).  If SQL Workbench is showing data from an \textit{Andika} database table, it places a lock on the table which prevents any other program accessing it for some operations (re-creating a table, renaming a field in the table, etc).  If you then try to run another import (eg to add some more stanzas you have just typed out), the import will hang because the script \textit{convert/create_poemlines.php} cannot delete that table and re-create it.  To allow the import to proceed, all you need to do is close SQL Workbench.  You can then reopen it after the import is complete.

\subsection{Saving a particular import}

Each time a poem text is imported, the import process will delete and then recreate the poem table containing the \textit{vipande} and their transliteration.  There is no real need for a backup, because the table (unlike the words table -- see \Cref{s:splitlines}) is simply a copy, in a different format of the input document.  However, if for some reason you want to preserve a specific conversion (perhaps for archival purposes), you can save (dump) the database table before re-running the conversion.  To create a file which can be loaded into a PostgreSQL database, open a terminal and run:

\verb|pg_dump -U dbuser --table=poem_name > poem_name.sql andika|

If I wanted to do this for the poem \textit{inkishafi}, I would run:

\verb|pg_dump -U kevin --table=inkishafi > inkishafi.sql andika|

To create a file which can be opened in a spreadsheet, run:

\verb|psql -U dbuser -d andika|\\
(replacing \textit{dbuser} with your database user)

\verb|\copy (select * from poem_name) to 'poem_name.csv' with delimiter ',' csv header|\\
(replacing \textit{poem_name} with the name of the poem)

\verb|\q|

You can do the same thing with phpPgAdmin.  
\begin{enumerate}
\item On the \textit{Tables} screen of the \textit{andika} database, click on the name of the poem.
\item Click on the \textbf{Export} button at the top of the page.
\item For a backup which can be loaded into PostgreSQL:
	\begin{enumerate}
    \item Tick \textbf{Structure and data}.
    \item Select \textbf{SQL} from the \textit{Format} drop-down list.
	\end{enumerate}
\item For a backup which can be opened in a spreadsheet:
	\begin{enumerate}
    \item Tick \textbf{Data only}.
    \item Select \textbf{CSV} from the \textit{Format} drop-down list.
	\end{enumerate}
\item Tick \textbf{Download}, and then click \textbf{Export}.
\item Select a location in which to save the file (you may want to create a directory in which to store the backups), and rename it as appropriate (you may want to add dates to the filenames).
\end{enumerate}

Andika! makes automatic backups for the next stage of import, splitting lines into words (see \Cref{ss:rerun}). 

\subsection{Adding stanzas to a poem import}
\label{ss:addstanzas}

This is an unlikely scenario, but is included here for completeness.  Suppose (a) your copy of a poem was missing a page, (b) you have come across another copy of that poem which contains the missing page, and (c) you no longer have access to your typed out (odt) version of the poem, but you want to include the new stanzas in the poem table without retyping the whole poem.  

Assume you have 5 new stanzas which fit in after stanza 115 of the existing poem as (new) stanzas 116 to 120.  You would:
\begin{enumerate}
\item Type out the new stanzas as a separate document, and import that as a separate poem (say, \textit{newbits}).
\item Adjust the numbering of the \textit{newbits} table to reflect their proper position in the existing poem:\\
\verb|update stanza set stanza=stanza+115|\\
This will change the stanza numbers from 1 to 116, 2 to 117, and so on.\footnote{Alternatively, you can edit \textit{convert/convert.php} -- see \Cref{ss:stanzano}.}
\item Make space for the new stanzas by moving the numbering of the existing poem stanzas forward:\\
\verb|update stanza set stanza=stanza+5 where stanza>115|
This will change the stanza numbers from 116 to 121, 117 to 122, and so on.
\item Copy the new stanzas from from the \textit{newbits} table into the poem table:\\
\verb|insert into poem select * from newbits|
\end{enumerate}


\section{Splitting lines into words}
\label{s:splitlines}

Now that the text of the poem is stored in a table (\textit{poem_name}), the next step is to split each \textit{kipande} of the poem into words, and store those in another table (\textit{poem_name_words}), which will allow each word to have individual annotations added to it.  To do this, open a terminal and run:

\verb|php db/import_words.php name_of_the_poem|

replacing \textit{name_of_the_poem} with whatever your poem name is.  In the example, you would run:

\verb|php db/import_words.php vita_vikuu|

Note that once the poem is imported into the database, the code relating to annotation and other editorial work is located in the directory \textit{db}, and not in \textit{convert}.

The import process will create a new table, \textit{name_of_the_poem_words} (in this case, \textit{vita_vikuu_words}), which you can again inspect using phpPgAdmin.  Each word has an entry of its own, consisting of fields similar to those used for the poem table (see above):
\begin{itemize}
\item An index number (\textit{word_id}).
\item The stanza number in which the word occurs, as written on the original manuscript (\textit{msno}).
\item The stanza number in which the word occurs, as generated by the software (\textit{stanza}).
\item The location of the \textit{kipande} in the stanza where the word occurs (\textit{loc})
\item The position the word occupies in the \textit{kipande}, eg first word, second word or whatever (\textit{position}).
\item The Arabic text (\textit{arabic}).
\item The close transcription (\textit{close}).
\item The standard transcription (\textit{standard}).
\end{itemize}

However, other fields are also created to hold annotations for data such as variants, general notes, an English translation, and so on (see \Cref{s:annotation}).

\subsection{Re-running word-splitting: backups}
\label{ss:rerun}

Note that each time \textit{import_words.php} is run (eg as you complete another batch of stanzas), it will delete and then recreate this words table.  Since you may well have devoted considerable time to editing the table and adding annotations (see \Cref{s:annotation}), it is important not to lose these!  So \textit{import_words.php} does the following things:
\begin{enumerate}
\item Creates (or, in the case of a re-import, re-creates) a backup of the \textit{words} table, which will include all your annotations and edits.  The name of this table is poem-name plus \textit{_backup}, e.g. \textit{vita_vikuu_backup}.
\item Archives any pre-existing backup (from earlier imports) in a table named poem-name plus \textit{_backup} plus date plus time.  An example would be \textit{inkishafi_backup_2017_11_23_16_45_35}, indicating that this archive backup was made at around 4.45pm on 23 November 2017.
\item Does the new import, as explained above in \Cref{s:splitlines}.
\item Adds your annotations and edits from the backup into the new import (see \Cref{s:annotation} below).
\end{enumerate}

In the normal course of events, you should never need to use the archive backups, but they are there to cover a case where something goes wrong with the import and you immediately re-run it.  This could lead to data loss -- the first import run creates a \textit{backup} table with all your annotations, but the second then deletes that good \textit{backup} table and creates a new one based on the faulty \textit{words} table, where the annotations may be missing.  The result is that your \textit{backup} table no longer cotains your annotations!  

The archive backups allow you to recover from this situation with your annotations intact, because you can copy fields manually from them to your \textit{words} table by using an SQL query like:

\verb|update inkishafi_words w set (edclose, edstan, emend, variant, note, english) = |\\
$\hookrightarrow$ \verb|(b.edclose, b.edstan, b.emend, b.variant, b.note, b.english)|\\
$\hookrightarrow$ \verb|from inkishafi_backup_2017_11_23_16_45_35 b|\\
$\hookrightarrow$ \verb|where w.stanza=b.stanza and w.loc=b.loc and w.position=b.position;|

The above query will copy the contents of the listed annotation fields from the archive backup table into the \textit{words} table.  \textcolor{red}{IMPORTANT!} If you run this query in SQL Workbench, you then need to commit (save) this update by selecting \textbf{SQL \textrightarrow\ Commit}, or by pressing \textbf{Alt+M}.

If you find that you are doing a lot of re-importing and this is leading to a good few archive backups, you can simply delete all but the most recent, provided your words import has gone smoothly.

\subsection{Renumbering stanzas during word-splitting}
\label{ss:renumber}

A problem can arise during word-splitting (\Cref{ss:rerun}) if between two imports you have renumbered the stanzas by changing the \textit{stanza_no} counter (\Cref{ss:stanzano}).  For instance, if you (a) import a set of excerpted stanzas with \textit{stanza_no} set to 0 (the default), (b) add annotations, (c) realise that you should have set the \textit{stanza_no} to (say) 275, because the excerpted stanzas begin at 276, and (d) reimport after having adjusted the \textit{stanza_no} to read \verb|stanza_number=275|, then although the annotations you made previously will be in the backup, they cannot be re-integrated into the new words table because they no longer have the same stanza number. 

For the above case, you can resolve this by running the following :

\verb|update poem_words w set (edclose, edstan, emend, variant, note, english, noshow) = |\\
$\hookrightarrow$ \verb|(b.edclose, b.edstan, b.emend, b.variant, b.note, b.english, b.noshow) from poem_backup b|\\
$\hookrightarrow$ \verb|where w.stanza-275=b.stanza and w.loc=b.loc and w.position=b.position;|

The above query subtracts 275 from the stanza numbers in the new excerpt table, so that they now match the numbers in the backup table, and then copies the annotation fields from the \textit{backup} table to the \textit{words} table.  \textcolor{red}{IMPORTANT!} If you run this query in SQL Workbench, you then need to commit (save) this update by selecting \textbf{SQL \textrightarrow\ Commit}, or by pressing \textbf{Alt+M}.


\section{Annotations}
\label{s:annotation}

It is possible to create as many fields in the \textit{words} table as are required to handle various annotation types, and the content of each of these fields can be selected and edited via code, which means that a versatile framework exists for any editorial apparatus.  The  most important annotation types are described below, but others will be discussed in \Cref{ch:analysis}, when we look at computer-aided analysis of the poem text.

\subsection{\textit{edclose} field}
\label{ss:edclose}
This field holds an edited version of the close transliteration, which can be used when you want to override the output given by the automatic close transcriber.   For instance, suppose that in the \textbf{Mwana Kupona} text (\Cref{fig:mwanakupona}) you wanted to rewrite \textit{ghain} (\textarabic{غ}) where it is used to represent \textit{ng}.  You could do this by adding an \textit{edclose} entry \textbf{nawulimingu} alongside the \textit{close} entry \textbf{nawulimiḡu}.  When the poem is typeset, an entry (if there is one) in the \textit{edclose} field will replace the equivalent one in the \textit{close} field.

The edclose field also allows the re-use of a specific existing close transliteration -- for instance, if you are typing out a manuscript which has already been published, and you need to replicate the close transliteration from that publication. In this case, you would add an \textit{edclose} entry alongside each \textit{close} entry to reflect that existing close transliteration.

\subsection{\textit{edstan} field}

This field holds an edited version of the standard transliteration, which can be used when you want to override the output given by the automatic standard transcriber.  When the poem is typeset, an entry (if there is one) in the \textit{edstan} field will replace the equivalent one in the \textit{standard} field.

This can be used in a number of situations:
\begin{itemize}
\item To make spelling corrections where the automatic transcriber gets things wrong, e.g. to change \textbf{akanyyamaa} to \textbf{akanyamaa}.
(eg changing \textit{ḡ} to \textit{ng}, or \textit{i} to \textit{e}), the \textit{edclose} field currently handles two other types of edits: and insertion of additional letters.
\item To segment the transliteration to reflect standard Swahili word boundaries, e.g. to separate particles like \AS{لَ زَ يَ نَ} (\textbf{na, ya, za, la}), etc that have been written connected in the Arabic text.  For example, in 1c of \textit{vita_vikuu}, you could add  \textbf{na khubuzi} in the \textit{edstan} field alongside the \textit{standard} field \textbf{nahubuzi}.
\item To connect elements that have been written separately in the Arabic text.  To do this, enter $\sim$ in the \textit{edstan} field alongside the \textit{standard} field element to be joined, and move the element to the proper cell.  For instance, in 1g of \textit{kiswahili}, standard Swahili requires \textbf{nimewatendani} (\textit{what have I done to you?}) instead of \textbf{ni mewatendani}.  So against \textbf{ni} we put a $\sim$ in the \textit{edstan} field, and edit the \textit{edstan} field of \textbf{mewatendani} to read \textbf{nimewatendani}.
\item To add epenthetic vowels to support proper scansion, you can use \verb|\In{text here}| (more information on annotation fonts is given in \Cref{ss:annotationfonts} below).  For instance, in 1c of \textit{vita_vikuu} an epenthetic vowel can be added to the transliteration of \AS{مِلْحِ} (\textbf{milḥi}, \textit{and salt}) to give \textbf{mil\In{i}ḥi} by editing the equivalent \textit{edstan} field to read \verb|na mil\In{i}ḥi|.
\item To allow the re-use of a specific existing standard transliteration -- for instance, if you are typing out a manuscript which
has already been published, and you need to replicate the standard transliteration from that publication. In this case, you would add an \textit{edstan} entry alongside each \textit{standard} entry to reflect that existing standard transliteration.
\end{itemize}

With some writers (e.g. Sheikh Yahya), the standard trancriber will result in text that is very close to standard Swahili in Roman script, because their Arabic script marks distinctions that reflect the phonology of Swahili.  Other writers (usually from earlier periods) have used the Arabic script as an approximation of the  phonology of Swahili (see \Cref{ch:fonts}) so the standard transliteration will reflect standard Swahili in Roman script less well.  In these cases, instead of re-typing entries into the \textit{edstan} field,  it may be easier to copy the contents of the \textit{standard} field to \textit{edstan}, and edit that (or delete entries where they are identical) -- this
may help reduce typos due to mistyping.  The following SQL query will accomplish this:

\verb|update poem_word set edstan=standard;|

\subsection{\textit{emend} field}

This field can be used where the copyist has written an incorrect word that requires emendation.  When the poem is typeset, an entry in this field will replace the equivalent entry in the \textit{standard} field, and will be marked in the output by a dotted underlinebelow the word.  For example, in the Inkishafi one \textit{kipande} reads \AS{نِسِكِيَ مَانَ نِكَبِيَاپُ} (\textbf{nisikia maana nikwambiapo}), which is one syllable longer than the expected 11.  This can be resolved by adding \textbf{sikia} in the \textit{emend} field alongside \textbf{nisikia}, and the line will then be output \textbf{\dotuline{sikia} maana nikwambiapo}.

Note the distinction between the \textit{emend} field and the \textit{edstan} field.  The former is used where the copyist has made an error that needs to be corrected.  The latter is used where the the written text only approximates standard Swahili, and needs to be rectified -- an example would be where the Inkishafi text above reads \textbf{nikabiyapu}, and we need to change that to \textbf{nikwambiapo} to reflect modern standard Swahili.

\subsection{\textit{variant} field}

This field allows the recording of variant readings (\textit{variae lectiones}) of the word in different manuscript versions of the same poem.  For instance, 6a of \textit{vita_vikuu} reads: \AS{نَسٖيْفُ نْجٖيْمَ أَسِيْسِ} (\textbf{nasēfu njēma ası̄si}, \textit{and a good, stout sword}).  If you have another manuscript B where this \textit{kipande} reads: \AS{نَسٖيْفُ نْزُوْرِ أَسِيْسِ} (\textbf{nasēfu nzūri ası̄si}), in the variant column against \textbf{njēma} we put (for instance):

\verb|B: \AS{|\texttt{\AS{نْزُوْرِ}}\verb|}, nzūri|

which will be converted to a footnote giving:

B: \AS{نْزُوْرِ }, nzūri.

\subsection{\textit{note} field}

This field holds notes on the meaning or reference of the word, or any other material which may help to elucidate its meaning or usage.  There is no practical limit on the length of these notes (the longest possible content that can be stored in any one field is about 1 GB).  \Cref{appD} demonstrates how \textbf{Andika!} caters easily for a significant number of notes -- for more information the relevant database table, \textit{kiswahili_words}, can be inspected.

To refer to other footnotes within notes, add a reference label to the source footnote:, e.g.

\verb|\label{fn:mynote}This is a footnote that we also want to refer to later.|

In the referring footnote, call that reference:

\verb|This footnote makes the same point we already made earlier - see footnote \ref{fn:mynote}.|

\subsection{\textit{english} field}

This field holds an English translation of the whole \textit{kipande}, placed against the first word of each \textit{kipande}.  See the \textit{kiswahili_words} table for examples.

\subsection{\textit{noshow} field}
\label{ss:noshow}

This field can be used to switch off the display of the standard transliteration for words or lines in the poem.  It will be discussed in more detail in \Cref{s:localopt} below.


\section{Adding and editing the annotations}

The best tool for adding the annotations to be added directly to the table is SQL Workbench (\Cref{ss:workbench}), since it allows direct entry into the individual fields.  Open SQL Workbench and connect to the \textit{andika} database.  In the top panel, enter an SQL query to show the whole of the \textit{vita_vikuu_words} table in order of stanza and \textit{kipande}:\\
\verb|select * from vita_vikuu_words order by stanza, loc, position;|\\
(note that the semi-colon at the end is essential)

Move the cursor somewhere inside the query and press \textbf{Ctrl+Return}.  You can now edit individual cells in order to add annotations.  

\textcolor{red}{IMPORTANT!} Remember to press the \textbf{Save} icon or select \textbf{Data \textrightarrow\ Save Changes to Database} to save any material you add.  Even though you can see your edits in SQL Workbench, they are not written into the database until you save them!

\subsection{Specifying fonts in the annotations}
\label{ss:annotationfonts}

Changes from the default font can be marked in any of the annotation types, and it is recommended to make such changes directly in the annotation, rather than try to edit the output file afterwards.  The alternate fonts use the font definitions as set up in the file \url{andika/convert/tex/fontdefs.tex}, and you can add more to that list using the patterns seen there (see also \Cref{s:changefont}).  To apply the font changes, the LaTeX command format is used: a backslash, then the abbreviation for the desired font, and then the text inside braces.  Likely font changes that might be applied are:
\begin{itemize}
\item Arabic script: \verb|\AS{text here}| -- Scheherazade.  To use Amiri, use \verb|\Am{text here}|
\item transliteration: \verb|\Tr{text here}| -- Linux Biolinum O in grey.
\item inserted letters: \verb|\In{text here}| -- Linux Biolinum O in blue.
\item standard Swahili: \verb|\Swa{text here}| -- Linux Biolinum O in green.
\item English: \verb|\E{text here}| -- Liberation Serif in grey italics, smaller than the default.
\item English italics: \verb|\Eit{text here}| -- Liberation Serif in black italics.	
\item standout type in footnote: \verb|\FN{text here}| -- Liberation Serif in green italics. 
\end{itemize}

\subsection{Inserting citations in the annotations}

All the annotation fields can include citations, but they are perhaps most likely in the \textit{note} field.  The citations use a LaTeX package called \textit{biblatex}, which has already been installed (\Cref{s:latex}).\footnote{The older \textit{bibtex} package does not support citations in footnotes.}  This draws on a list of the citations you wish to use, which need to be in BibTeX format -- see \url{andika/bib/andika.bib} for an example of a short bibliography file.  It is possible to write this file using just a text editor, but it is easier to use a frontend such as JabRef, which has already been installed (\Cref{s:jabref}).  With a frontend, you simply type the bibliographic details of the citation into a series of dialogue boxes.  Each citation is referred to by a ``key'' -- I use the name of the first author and the year, so the key for Sacleux' \textit{Dictionnaire} would be \textit{Sacleux1939}, but you can use anything you like.

Using this dictionary as an example, we can then refer to a citation in the note by using:\\
\verb|\textcite{Sacleux1939}|\\
where the work is a subject:
\begin{quotation}
Sacleux (1939) was a major achievement in Swahili lexicography.
\end{quotation}
and using:\\
\verb|\parencite{Sacleux1939}| \\
where the work is referred to parenthetically:
\begin{quotation}
This word is found mainly in northern dialects (Sacleux 1939).
\end{quotation}

The \textit{author-year} citation style is default, but it can be changed.  However, since citation management and style is a wide-ranging topic not directly relevant to \textbf{Andika!}, this aspect is not dealt with here.

The bibliography file has to be called \textit{andika.bib}, and has to be in the \url{andika/bib} directory.  You can either add your citation details to that file, or delete it and start your own \textit{andika.bib}.  If you need to use a bibliography file of a different name in a different location, you can delete the existing \textit{andika.bib} and set up a symbolic link to your own file.  For instance, if your bibliography file were called \textit{thesis.bib}, and it was located in \url{/home/USER/thesis} (where \textit{USER} is your username), you would run the following commands in a terminal open at \textit{andika}:

\verb|rm bib/andika.bib|\\
(delete the existing \textit{andika.bib} file)

\verb|ln -s ~/thesis/thesis.bib bib/andika.bib|\\
(create an \textit{andika.bib} link (alias or shortcut) to your bibliography file -- remember that $\sim$ stands for \textit{/home/USER})

It is worth noting that in cases where citations are not printed properly, it is virtually always the case that there is an error in the bibliography file, or that the key being used is incorrect.\footnote{I recently spent almost an hour trying to work out why the entry for \citet{Abdulkadir2013}, key \texttt{Abdulkadir2013}, was not appearing correctly - there were definitely no mistakes in the bibliography entry.  Yet LaTeX reported it could not find that entry.  I tried various increasingly complicated fixes, until eventually I noticed that I had typed the key as \texttt{Adbulkadir2013} when citing the work.  When a problem like this arises, we tend to think that the most likely cause is a fault in the software, but it is far more likely to be a fault in the wetware connecting the chair to the computer.}

\subsection{Adding annotations in batches}

When working on a long poem, it is often more convenient to add annotations in batches of (say) 20.  This means that your work can be reviewed easily, and typos corrected, without having to scroll through the whole words table in SQL Workbench, and it also means that generation of the pdf for checking will be faster, since it only includes a subset of the poem's stanzas.

To do this, set the query in SQL Workbench to call only the relevant items from the words table.  In the following query, you are working on stanzas 80-100 of \textit{jaafari}, and need to see only the \textit{standard} and \textit{edstan} fields so that you can add an English translation and any notes that are appropriate:

\verb|select word_id, stanza, loc, position, standard, edstan, english, note from jaafari_words|
$\hookrightarrow$ \verb|where stanza between 80 and 100 order by stanza, loc, position;|

Skipping ahead a little (see \Cref{ss:mton}), to print out only this batch of stanzas, use the option \textit{MtoN} :

\verb|db/output_pdf.php jaafari 80to100|


\section{Output to pdf}
\label{s:output}

Once the database table holding the words of the poem has been edited to include all the annotations required, it can be output in a variety of formats.  The most important is the \textit{pdf} format,\footnote{Output to \textit{html} will be added at a later stage.} since the LaTeX typesetting system produces a very attractive, beautifully laid-out text equally suitable for traditional printing or digital distribution.  A variety of layouts is possible (see also \Cref{ch:multiple}) but the default is to print two \textit{vipande} to the line, with an asterisk between them.

To print your annotated poem in the default layout to a pdf file, run:

\verb|php db/output_pdf.php poem_name| 

The generated pdf will be located in a folder with the same name as your input document -- in this case \textit{andika/db/outputs/poem_name}.

To demonstrate the layout options, we will use one stanza from the beginning of the \textit{Utenzi wa Jaafari}.  The input document for this is in \textit{convert/inputs/egoutput.odt}.  After converting to database format, importing the words, and adding an English translation, we can run:

\verb|php db/output_pdf.php egoutput|

to give \textit{andika/db/outputs/egoutput/egoutput.pdf} -- see \Cref{fig:output:default}.

\begin{figure}[H] 
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
% \captionsetup{textfont={rm}}
% \caption{\textit{Output from}: \ttfamily{php db/output_pdf.php egoutput}}
\caption{Default output}
\label{fig:output:default}
\end{figure}

\section{Output: global display options}
\label{s:globalopt}

The default output in \Cref{fig:output:default} can be adjusted in a number of ways by passing various options to output_pdf.php.  Those in this section are ``global'' options, in that they apply to the poem as a whole.  The next section (\Cref{s:localopt}) will explain some further options which are ``local'', in that they can be applied to individual words or lines in the poem.

\subsection{Stanzas to be printed}
\label{ss:mton}

By default, all stanzas of the poem will be printed out.  However, you can print out a contiguous subset of stanzas by using the option \verb|MtoN|, where M is the number of the first stanza in the set, and N is the number of the last stanza in the set.  For instance, the following command will print out only stanzas 80 to 100 of the poem \textit{jaafari}:

\verb|php db/output_pdf.php jaafari 80to100|

\subsection{Font size}
\label{s:outfont}

The default font size for the output is 10pt, which is good for printing.  However, if you need a slightly larger font, you can use the option \verb|12pt| to increase font size to 12 pt.

\verb|php db/output_pdf.php egoutput 12pt|

% \fontsize{12}{14}
% \selectfont
\begin{figure}[H]
\begin{large}
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\end{large}
\caption{Output with larger font size}
\label{fig:output:fontsize}
\end{figure}
% \fontsize{10}{12}
% \selectfont

\subsection{Changing the location of annotations}
\label{s:outloc}

By default, all annotations are output as footnotes -- since they refer to individual words in the text, having them on the same page is easier to read.  But if you need endnotes instead, you can use the option \verb|endnote| to remove the annotations from the bottom of the page, and move them into their own section after the poem:

\verb|php db/output_pdf.php egoutput endnotes|

To compare the difference in output, look at \Cref{appD} and \Cref{appF}.

\subsection{Colours}
\label{ss:colours}

The Arabic script is printed in green, but this can be changed in \textit{output_pdf.php} by editing the line:

\verb|$colour1="mygreen";|

to use one of the default colours (red, green, blue, cyan, magenta, yellow, black, gray, white, darkgray, lightgray, brown, lime, olive, orange, pink, purple, teal, violet), or a new default colour can be set up at the bottom of \textit{convert/tex/fontdefs.tex}.

The first line of Arabic script can be printed in a different colour by using the option \verb|firstcolour|:

\verb|php db/output_pdf.php egoutput firstcolour|

giving the output in \Cref{fig:output:firstcolour}.  Again, the colour can be adjusted in \textit{output_pdf.php} by editing the line:

\verb|$colour2="blue";|

or a new default colour can be set up at the bottom of \textit{convert/tex/fontdefs.tex}.  This option is useful for setting off lines in Arabic when they occur in the same stanza as lines in Swahili (e.g. in the Burda -- see \Cref{ss:burda}).

\begin{figure}[H] 
\begin{longtable}{cl} 
\textcolor{blue}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Option: firstcolour}
\label{fig:output:firstcolour}
\end{figure}

If no colour other than black is desired in the output, use the option \verb|nocolour| (see \Cref{fig:output:nocolour}):

\verb|php db/output_pdf.php egoutput nocolour|

\begin{figure}[H] 
\begin{longtable}{cl} 
\textcolor{black}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{black}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Option: nocolour}
\label{fig:output:nocolour}
\end{figure}

\subsection{Alignment}
\label{ss:alignment}

As \Cref{fig:output:default} shows, the default alignment for the poem text is centred, but this can be changed to right-justified by using the option \verb|alignright| (see \Cref{fig:output:alignright}):

\verb|php db/output_pdf.php egoutput alignright|

\begin{figure}[H]
\begin{longtable}{rl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Option: alignright}
\label{fig:output:alignright}
\end{figure}

The option \verb|alignleft| is also available, but this is best applied where the Arabic script is not being printed out (see \Cref{ss:omittrans}).

\subsection{Omitting tiers}
\label{ss:omittrans}

Even if an English translation has been added to the words table, it can be omitted by using the option \verb|noenglish| (see \Cref{fig:output:noenglish}):

\verb|php db/output_pdf.php egoutput noenglish|

\begin{figure}[H]
\begin{longtable}{cl}
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\*
\\[2mm] 
\end{longtable} 
\caption{Option: noenglish}
\label{fig:output:noenglish}
\end{figure}

The standard transcription can also be omitted by using the option \verb|nostandard|  -- adding this to the \verb|noenglish| option means that only the Arabic script will be printed (see \Cref{fig:output:nostannoeng}).  This may be useful if the Arabic script is being relegated to an appendix, with the standard transcription and/or the English translation being extracted and typeset separately to form the main text. Since the only remaining tier is written right-to-left, it may also be appropriate to apply the option \verb|alignright|.  Multiple options can be passed (in any order) to \textit{output_pdf.php} by linking them with a plus sign:

\verb|php db/output_pdf.php egoutput nostandard+noenglish+alignright|

\begin{figure}[H]
\begin{longtable}{rl}
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\*
\\[2mm] 
\end{longtable} 
\caption{Option: nostandard+noenglish+alignright}
\label{fig:output:nostannoeng}
\end{figure}

Note that if the standard transcription is suppressed, any footnote numbers attached to it (for variant readings or notes) will be attached to the Arabic script instead.  Also note that no emendations at all will be shown, since they are assumed to apply only to the standard transcription.

The complement of the example in \Cref{fig:output:nostannoeng} is where you want to print only the standard transcription and the English translation -- the \verb|noarabic| option will suppress the output of the Arabic script (see \Cref{fig:output:noarabic}).  Since the remaining tiers are written left-to-right, it may also be appropriate to apply the option \verb|alignleft|.

\verb|php db/output_pdf.php egoutput noarabic+alignleft|

\begin{figure}[H]
\begin{longtable}{ll}
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Option: noarabic+alignleft}
\label{fig:output:noarabic}
\end{figure}

\subsection{Displaying the close transcription}
\label{ss:showclose}

In the case of older manuscripts where the Arabic script is more of an approximation to the Swahili it represents, it may be helpful to provide a close transcription as well.  This will be printed in the same colour as the Arabic script above it, and the option \verb|close-lr| will print it left-to-right (see \Cref{fig:output:close-lr}).

\verb|php db/output_pdf.php egoutput close-lr|

\begin{figure}[H]
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
\textcolor{mygreen}{\OLTcl{pulikani nduzangu * kʰenda matembezi yangu}} & \\* 
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
\textcolor{mygreen}{\OLTcl{niwape khabari zangu * qiṣa chalonijiriya}} & \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Option: close-lr}
\label{fig:output:close-lr}
\end{figure}

The option \verb|close-rl| is also available, and will print the close transcription right-to-left; that is, the close transcription of each word will appear directly under the Arabic script for that word (see \Cref{fig:output:close-rl}).

\verb|php db/output_pdf.php egoutput close-rl|

\begin{figure}[H]
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
\textcolor{mygreen}{\OLTcl{yangu matembezi kʰenda * nduzangu pulikani}} & \\* 
pulikani nduzangu * kenda matembezi yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
\textcolor{mygreen}{\OLTcl{chalonijiriya qiṣa * zangu khabari niwape}} & \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm]
\end{longtable} 
\caption{Option: close-rl}
\label{fig:output:close-rl}
\end{figure}

Simultaneously suppressing the standard transliteration will leave only the close transcription -- see \Cref{fig:output:close-only}.  In this case, as noted above (\Cref{ss:omittrans}), any annotations giving notes or variants will be attached to the Arabic script.  Note that in this case there is no Roman numbering of the stanzas -- if this is required, an alternative method is suggested below.

\verb|php db/output_pdf.php egoutput close-rl+nostandard|

\begin{figure}[H]
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
\textcolor{mygreen}{\OLTcl{yangu matembezi kʰenda * nduzangu pulikani}} & \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
\textcolor{mygreen}{\OLTcl{chalonijiriya qiṣa * zangu khabari niwape}} & \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Option: close-rl+nostandard}
\label{fig:output:close-only}
\end{figure}


\section{Output: local display options}
\label{s:localopt}

The output options described in \Cref{s:globalopt} are ``all or nothing'' -- they apply to the whole poem.  \textit{Andika!} provides a further mechanism to control output when you wish an option to apply only to particular words or \textit{vipande}.  This is based on the \textit{noshow} field (\Cref{ss:noshow}).  By default, this field is empty for each word, but if a tag is entered in the field, the display of that word can be controlled in detail.  Currently, this covers the transcription output only, but it could easily be extended to handle other aspects of the display.

The principle can be demonstrated by looking at how to suppress the standard transcription for a word -- let us assume that we want to suppress the printing of \textbf{matembezi} in 1b.  To do this, open the words table in SQL Workbench and put something (anything) in the \textit{noshow} field -- the only condition is that the something should be less than 10 characters long (you are also recommended to make it at least two characters long, so that you can't confuse it with the \textit{vipande} notation).  To focus on what we are doing, the  SQL query will pick out only those fields relevant to this task:

\verb|select word_id, stanza, loc, position, arabic, close, standard, noshow from|\\
$\hookrightarrow$ \verb|egoutput_words order by stanza, loc, position;|

In the \textit{noshow} field alongside \textbf{matembezi}, enter something so that the entry looks like \Cref{fig:noshow}, and then press the \textbf{Save} icon or select \textbf{Data \textrightarrow\ Save Changes to Database} to save this edit. 

\begin{figure}[H]
\centering
\includegraphics{images/noshow.png}
\caption{Making an entry in the noshow field}
\label{fig:noshow}
\end{figure}

Running \textit{output_pdf.php} will then print the text with that word missing from the transcription (see \Cref{fig:local:oneword}):

\verb|php db/output_pdf.php egoutput|

\begin{figure}[H]
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
pulikani nduzangu * kenda yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Suppressing the transcription for a word}
\label{fig:local:oneword}
\end{figure}

In order for omitted words to be shown as having been omitted, \textit{output_pdf.php} has a preset to mark them.  In SQL Workbench, change ``blah'' to ``omit'', and then save the edit.  Running \textit{output_pdf.php} again will now show the omitted word's location with three grey Xs (see \Cref{fig:local:omit}):

\begin{figure}[H]
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
pulikani nduzangu * kenda \textcolor{lightgray}{XXX} yangu & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Omitting a word}
\label{fig:local:omit}
\end{figure}

\subsection{Suppressing a line of transcription}

It is difficult to envisage an editorial situation in which omitting a single word might be useful, but suppressing a transcription for \textit{all} the words in a line might be so in some cases.  An example might be stanzas which contain lines in either Arabic and Swahili (e.g. the Burda) -- here you might want to present the Arabic without transcription and the Swahili with.  This can be achieved by making an entry in the \textit{noshow} field against all of the words in the line you want no transcription for.   If we want to suppress the transcription for the first line of the sample stanza, for instance, we can enter ``ar'' against all of the words in both \textit{vipande}\footnote{Strictly speaking, marking the words in just one \textit{kipande} will suppress the transcription in both -- i.e. marking the words in \textit{kipande c} will suppress the transcription in \textit{d} as well as that in \textit{c}.  This is to make the display neater, but it is possible to suppress only one \textit{kipande} in the line instead of both -- see the note in the\textit{ output_pdf.php} code.} (see \Cref{fig:suppressline} -- in effect, by doing this we are applying the global \textit{nostandard} option to that line alone.  This gives the output in \Cref{fig:local:suppress}.  Note that the stanza/\textit{kipande} information in the margin is no longer printed, since there is no transcription for it to apply to,

\begin{figure}[H]
\centering
\includegraphics{images/suppressline.png}
\caption{Marking the words of the first line in the stanza}
\label{fig:suppressline}
\end{figure}

\begin{figure}[H]
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
\E{ } & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Suppressing a line}
\label{fig:local:suppress}
\end{figure}

The ``ar'' entry is a preset which suppresses both the standard transcription and any English translation.  If you want to retain the translation, you can use another preset, ``areng''.  Replacing ``ar'' with ``areng'' in the words table, and adding the \textit{firstcolour}  option (\Cref{ss:colours}) gives the output in \Cref{fig:local:areng}.  (Of course, the ``nocolour'' option can also be applied to change all colours to black.)  It would possible to expand this system to add other actions -- for instance, you could add a new trancription system purely for Arabic, and set ``ar'' to include processing to insert that specially devised trancription into the \textit{close} (or a new) field.  If there were a (hypothetical) Swahili commentary on a Farsi poem, the Farsi lines could be marked ``fa'', and a new transcription system devised for Farsi.

\begin{figure}[H]
\begin{longtable}{cl} 
\textcolor{blue}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Suppressing a line but retaining a translation}
\label{fig:local:areng}
\end{figure}

\subsection{Swapping in the close transcription}

However, short of creating a new close transcription, another possibility is to use the existing one provided by \textit{Andika!}, perhaps editing it as necessary by making entries in the edclose field (see \Cref{ss:edclose}).  You can do this by using the option \verb|swapclose|, which inserts the close transcription instead of the standard transcription in any line where the words have an entry in the \textit{noshow} field.  (Note that \verb|swapclose| will have no effect if there is no entry in the \textit{noshow} field - in that case, the standard transcription will be printed out as normal.)  The example in \Cref{fig:local:swapclose} uses the ``areng'' entry against the words in line 1 -- the English translation could also be suppressed by changing that entry to ``ar''.

\verb|php db/output_pdf.php egoutput swapclose|

It is worth noting that swapping in the close transcription can be used for any lines where there is a relevant entry in the \textit{noshow} field -- i.e. it does not just apply to \textit{vipande} a and b.

\begin{figure}[H]
\begin{longtable}{cl} 
\textcolor{mygreen}{\textarabic{پُلِكَنِ نْدُزَنْڠُ * كهٖنْدَ مَتٖمْبٖزِ يَنْڠُ}} & \textarabic{١} \\* 
\textcolor{mygreen}{\OLTcl{pulikani nduzangu * kʰenda matembezi yangu}} & 1a/b \\* 
\E{Listen, my brothers, I went on a journey.} & \\[2mm] 
\textcolor{mygreen}{\textarabic{نِوَپٖ خَبَرِ زَنْڠُ * قِصَ چَلٗنِجِرِيَ}} &  \\* 
niwape habari zangu * qisa chalonijiriya & 1c/d \\* 
\E{Let me give you my story, an account of what happened to me.} & \\[2mm] 
\end{longtable} 
\caption{Swapping in the close transcription}
\label{fig:local:swapclose}
\end{figure}

\subsection{Making entries in the noshow field}

It is easy to run an SQL query to add tags to each noshow field:

\verb|update egoutput_words set noshow='ar';|

to delete all of them:

\verb|update egoutput_words set noshow='';|

or to change one to another:

\verb|update egoutput_words set noshow='ar' where noshow='areng';|

To simplify adding tags to each noshow field, \textit{Andika!} provides a helper script, \textit{manage_noshow.php}.  (It is also possible to use SQL queries directly on the words table itself, but the script makes things a little faster.)  Arguments are passed to the script in the following order:
\begin{enumerate}
\item Name of the poem (i.e. the words table shorn of \textit{_words}).
\item The action to be taken.  Two actions are possible: \textit{fill} (to insert tags), and \textit{clear} (to remove them).
\item The stanzas to be targetted.  There are two possibilities: \textit{all}, which will apply a tag to the words in every stanza in the poem, or a list of stanzas.  The latter is a comma-separated list of numbers with NO spaces, which can also include ranges separated by a hyphen.  For instance, \textit{2,5,6} would target those three stanzas, while \textit{4,6-8,10-13,17,20} would target the stanzas 4, 6, 7, 8, 10, 11, 12, 13, 17 and 20. 
\item The locations (\textit{vipande}) to be targetted.  This is a comma-separated list of lower-case letters with NO spaces, which can also include ranges separated by a hyphen.  For instance, \textit{a,b} or \textit{a-b} would target \textit{vipande a} and \textit{b}, while \textit{c-d,g-h} would target \textit{vipande c, d, g} and \textit{h}.  This argument can be omitted if you are using the default tag ``ar'' -- if \textit{vipande} within the stanza are not specified, the ``ar'' tag will be applied to the words in every \textit{kipande} in that stanza.  HOWEVER, if you are specifying a tag other than ``ar'', you must include this argument.
\item  The tag to be inserted, e.g. \textit{ar}, \textit{areng}, \textit{omit}, or a tag of your own devising.  This argument can be omitted, in which case the default tag ``ar'' will be used.  With the \textit{clear} action, no tag is necessary, but if one is given it will be ignored.
\end{enumerate}

Some examples follow:

Add an ``ar'' \textit{noshow} tag to every word in the table \textit{poem_words} (remember that the ``ar'' tag is applied by default if no tag is specified):

\indent\verb|php db/manage_noshow.php poem fill all|\footnote{SQL: \ttfamily{update poem_words set noshow='ar';}}

Delete all \textit{noshow} tags from the \textit{poem_words} table:

\indent\verb|php db/manage_noshow.php poem clear all|\footnote{SQL: \ttfamily{update poem_words set noshow='';}}

Add an ``ar'' tag to every first line (specifying ``ar'' is optional):

\indent\verb|php db/manage_noshow.php poem fill all a,b ar|\footnote{SQL: \ttfamily{update poem_words set noshow='ar' where loc in ('a', 'b');}}

Add an ``areng'' tag to every third line:

\indent\verb|php db/manage_noshow.php poem fill all e-f areng|\footnote{SQL: \ttfamily{update poem_words set noshow='areng' where loc in ('e', 'f');}}

Change all tags in the third line (``areng'') to another (``mytag''):

\indent\verb|php db/manage_noshow.php poem fill all e-f mytag|\footnote{SQL: \ttfamily{update poem_words set noshow='mytag' where loc in ('e', 'f');} or: \ttfamily{update poem_words set noshow='mytag' where noshow='areng';}}

Add an ``ar'' tag to every word in stanzas 1, 3 and 5:

\indent\verb|php db/manage_noshow.php poem fill 1,3,5|\footnote{SQL: \ttfamily{update poem_words set noshow='ar' where stanza in (1, 3, 5);}}

Add an ``areng'' tag to every word in stanzas 2, 4 and 6 -- assuming 6 \textit{vipande} in each stanza (remember that if you are using a tag other than the default ``ar'' you not only have to specify that, you also have to specify the \textit{vipande}):\footnote{If you accidentally omit the vipande locations, there's no harm done -- no changes will be made to the table.}

\indent\verb|php db/manage_noshow.php poem fill 2,4,6 a-f areng|\footnote{SQL: \ttfamily{update poem_words set noshow='areng' where stanza in (2, 4, 6) and loc in ('a', 'b', 'c', 'd', 'e', 'f');}}

Add an ``ar'' tag to the first line of stanzas 6, 7, 8, 11, 12, 13 and 21:

\indent\verb|php db/manage_noshow.php poem fill 6-8,11-13,21 a-b|\footnote{SQL: \ttfamily{update poem_words set noshow='ar' where stanza in (6, 7, 8, 11, 12, 13, 21)  and loc in ('a', 'b');}}



% \footnote{Aspiration replaces 1S personal prefix 'ni-'.}  
% \footnote{'qisa' is assumed to be in class 7, '*kisa'.} 

% ===== For later addition =====

% \subsection{Output to html}
% 
% Output to html (the most likely format for web publication) is shown in this html file. In this version, the transcription colour has been changed to blue to fit in with the site livery, and lemma adjustments are in purple. Notes are displayed in a pop-up when the mouse hovers over the note number (to dismiss the note, click on it and move the mouse away). An example of how variant readings might be handled is given in stanza 142 - hovering over the word with a grey background pops up the variant. (Note that this variant reading is an invention for the purposes of this example.)
% 
% A paging mechanism could be added to allow easy navigation through a long text.
% 
% Again, it would be relatively simple to adjust the layout and contents of the html output to meet other requirements, and indeed, a variant is shown below.
% 
% 
% \subsection{Output to odt}
% 
% Output to odt (LibreOffice format) is only indirectly supported - it is handled by generating a standalone html file. In this, notes to the text are printed at the end of the entire text, with the endnote number marked in red in the text. The endnote number in the text is a link to the endnote, and the number beside the endnote itself is a link back to the relevant word in the text. To create an odt document from this, open the file in the default KDE web-browser Rekonq (see below), and copy the text using Ctrl+A and Crtl+C. Then open a new LibreOffice document and use Ctrl+V to paste the text into that. When saving the file in LibreOffice, select odt as the save format.
% 
% Note that, of the browsers available on Linux, Rekonq provides the best results. It retains all the formatting (fonts, colours, etc), and converts the endnote links in the resulting odt file so that they can be accessed by pressing Ctrl while clicking. Chromium retains the formatting, but does not convert the links, so that they still point to the original html file, and clicking them opens that file in a browser. Chromium also converts some spaces to non-breaking spaces, which are marked with a grey background - to get rid of this, select Tools → Options → LibreOffice Writer → Formatting Aids, untick Non-breaking spaces, and press OK. Firefox is worst of all, losing all the formatting, and leaving the links unconverted. Note that even with Rekonq and Chromium, though, you will need to select all the endnotes in LibreOffice and press the LTR button in order to align them to the left.
% 
% You can also open the html file in LibreOffice itself, but in this case you will not be able to save it as an odt file. 





